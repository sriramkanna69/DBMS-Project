package com.library;

import javax.swing.*;
import javax.swing.border.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.sql.*;

public class LibraryGUI extends JFrame {
    private static final String URL = "jdbc:mysql://localhost:3306/librarydb";
    private static final String USER = "root";
    private static final String PASSWORD = "";

    private Connection conn;

    public LibraryGUI() {
        // Window setup
        setTitle("ðŸ“š Library Management System");
        setSize(900, 650);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        getContentPane().setBackground(new Color(245, 250, 255));
        setLayout(new BorderLayout(10, 10));

        // Connect to DB
        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            conn = DriverManager.getConnection(URL, USER, PASSWORD);
            System.out.println("âœ… Connected to MySQL!");
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Database Connection Failed: " + e.getMessage());
            System.exit(1);
        }

        // Header
        JLabel title = new JLabel("ðŸ“š Library Management System", JLabel.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 22));
        title.setForeground(new Color(25, 118, 210));
        title.setBorder(new EmptyBorder(15, 10, 15, 10));
        add(title, BorderLayout.NORTH);

        // Tabs
        JTabbedPane tabs = new JTabbedPane();
        tabs.setFont(new Font("Segoe UI", Font.BOLD, 14));
        tabs.add("âž• Add Book", createAddBookPanel());
        tabs.add("ðŸ‘¤ Register Member", createRegisterMemberPanel());
        tabs.add("ðŸ“– Borrow Book", createBorrowPanel());
        tabs.add("ðŸ” Return Book", createReturnPanel());
        tabs.add("ðŸ“š View Books", createViewBooksPanel());
        tabs.add("ðŸ‘¥ View Members", createViewMembersPanel());
        add(tabs, BorderLayout.CENTER);
    }

    // ---------- Add Book ----------
    private JPanel createAddBookPanel() {
        JPanel panel = createStyledPanel(4);
        JTextField titleField = new JTextField();
        JTextField authorField = new JTextField();
        JTextField copiesField = new JTextField();
        JButton addBtn = createButton("Add Book");

        panel.add(new JLabel("Title:")); panel.add(titleField);
        panel.add(new JLabel("Author:")); panel.add(authorField);
        panel.add(new JLabel("Copies:")); panel.add(copiesField);
        panel.add(new JLabel("")); panel.add(addBtn);

        addBtn.addActionListener(e -> {
            try {
                String sql = "INSERT INTO books (title, author, copies) VALUES (?, ?, ?)";
                PreparedStatement ps = conn.prepareStatement(sql);
                ps.setString(1, titleField.getText());
                ps.setString(2, authorField.getText());
                ps.setInt(3, Integer.parseInt(copiesField.getText()));
                ps.executeUpdate();
                JOptionPane.showMessageDialog(this, "âœ… Book added!");
                titleField.setText(""); authorField.setText(""); copiesField.setText("");
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "âš ï¸ Error: " + ex.getMessage());
            }
        });
        return panel;
    }

    // ---------- Register Member ----------
    private JPanel createRegisterMemberPanel() {
        JPanel panel = createStyledPanel(3);
        JTextField nameField = new JTextField();
        JTextField emailField = new JTextField();
        JButton registerBtn = createButton("Register");

        panel.add(new JLabel("Name:")); panel.add(nameField);
        panel.add(new JLabel("Email:")); panel.add(emailField);
        panel.add(new JLabel("")); panel.add(registerBtn);

        registerBtn.addActionListener(e -> {
            try {
                String sql = "INSERT INTO members (name, email) VALUES (?, ?)";
                PreparedStatement ps = conn.prepareStatement(sql);
                ps.setString(1, nameField.getText());
                ps.setString(2, emailField.getText());
                ps.executeUpdate();
                JOptionPane.showMessageDialog(this, "âœ… Member registered!");
                nameField.setText(""); emailField.setText("");
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "âš ï¸ Error: " + ex.getMessage());
            }
        });
        return panel;
    }

    // ---------- Borrow Book ----------
    private JPanel createBorrowPanel() {
        JPanel panel = createStyledPanel(3);
        JTextField memberIdField = new JTextField();
        JTextField bookIdField = new JTextField();
        JButton borrowBtn = createButton("Borrow");

        panel.add(new JLabel("Member ID:")); panel.add(memberIdField);
        panel.add(new JLabel("Book ID:")); panel.add(bookIdField);
        panel.add(new JLabel("")); panel.add(borrowBtn);

        borrowBtn.addActionListener(e -> {
            try {
                int memberId = Integer.parseInt(memberIdField.getText());
                int bookId = Integer.parseInt(bookIdField.getText());

                Statement stmt = conn.createStatement();
                ResultSet rs = stmt.executeQuery("SELECT copies FROM books WHERE id=" + bookId);
                if (rs.next()) {
                    int copies = rs.getInt("copies");
                    if (copies > 0) {
                        String loanSql = "INSERT INTO loans (book_id, member_id, loan_date) VALUES (?, ?, CURDATE())";
                        PreparedStatement ps = conn.prepareStatement(loanSql);
                        ps.setInt(1, bookId);
                        ps.setInt(2, memberId);
                        ps.executeUpdate();
                        stmt.executeUpdate("UPDATE books SET copies=copies-1 WHERE id=" + bookId);
                        JOptionPane.showMessageDialog(this, "âœ… Book borrowed!");
                    } else {
                        JOptionPane.showMessageDialog(this, "âŒ No copies available!");
                    }
                } else {
                    JOptionPane.showMessageDialog(this, "âŒ Invalid Book ID!");
                }
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "âš ï¸ Error: " + ex.getMessage());
            }
        });
        return panel;
    }

    // ---------- Return Book ----------
    private JPanel createReturnPanel() {
        JPanel panel = createStyledPanel(2);
        JTextField loanIdField = new JTextField();
        JButton returnBtn = createButton("Return");

        panel.add(new JLabel("Loan ID:")); panel.add(loanIdField);
        panel.add(new JLabel("")); panel.add(returnBtn);

        returnBtn.addActionListener(e -> {
            try {
                int loanId = Integer.parseInt(loanIdField.getText());
                Statement stmt = conn.createStatement();
                ResultSet rs = stmt.executeQuery("SELECT book_id FROM loans WHERE id=" + loanId + " AND return_date IS NULL");
                if (rs.next()) {
                    int bookId = rs.getInt("book_id");
                    stmt.executeUpdate("UPDATE loans SET return_date=CURDATE() WHERE id=" + loanId);
                    stmt.executeUpdate("UPDATE books SET copies=copies+1 WHERE id=" + bookId);
                    JOptionPane.showMessageDialog(this, "âœ… Book returned!");
                } else {
                    JOptionPane.showMessageDialog(this, "âŒ Invalid or already returned loan ID!");
                }
            } catch (Exception ex) {
                JOptionPane.showMessageDialog(this, "âš ï¸ Error: " + ex.getMessage());
            }
        });
        return panel;
    }

    // ---------- View Books (Search + Delete) ----------
    private JPanel createViewBooksPanel() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBackground(Color.WHITE);

        String[] columns = {"ID", "Title", "Author", "Copies"};
        DefaultTableModel model = new DefaultTableModel(columns, 0);
        JTable table = new JTable(model);
        JScrollPane scrollPane = new JScrollPane(table);

        JTextField searchField = new JTextField(15);
        JButton searchBtn = createButton("ðŸ” Search");
        JButton refreshBtn = createButton("ðŸ”„ Refresh");
        JButton deleteBtn = createButton("ðŸ—‘ï¸ Delete");

        JPanel topPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        topPanel.add(new JLabel("Search (Title/Author): "));
        topPanel.add(searchField);
        topPanel.add(searchBtn);
        topPanel.add(refreshBtn);
        topPanel.add(deleteBtn);

        panel.add(topPanel, BorderLayout.NORTH);
        panel.add(scrollPane, BorderLayout.CENTER);

        searchBtn.addActionListener(e -> searchBooks(model, searchField.getText()));
        refreshBtn.addActionListener(e -> loadBooks(model));
        deleteBtn.addActionListener(e -> deleteSelectedBook(table, model));

        loadBooks(model);
        return panel;
    }

    private void deleteSelectedBook(JTable table, DefaultTableModel model) {
        int row = table.getSelectedRow();
        if (row == -1) {
            JOptionPane.showMessageDialog(this, "Please select a book to delete.");
            return;
        }

        int id = (int) model.getValueAt(row, 0);
        int confirm = JOptionPane.showConfirmDialog(this, "Are you sure you want to delete this book?", "Confirm Delete", JOptionPane.YES_NO_OPTION);

        if (confirm == JOptionPane.YES_OPTION) {
            try {
                PreparedStatement ps = conn.prepareStatement("DELETE FROM books WHERE id = ?");
                ps.setInt(1, id);
                ps.executeUpdate();
                model.removeRow(row);
                JOptionPane.showMessageDialog(this, "ðŸ—‘ï¸ Book deleted successfully!");
            } catch (Exception e) {
                JOptionPane.showMessageDialog(this, "Error deleting book: " + e.getMessage());
            }
        }
    }

    private void searchBooks(DefaultTableModel model, String query) {
        model.setRowCount(0);
        try {
            PreparedStatement ps = conn.prepareStatement("SELECT * FROM books WHERE title LIKE ? OR author LIKE ?");
            ps.setString(1, "%" + query + "%");
            ps.setString(2, "%" + query + "%");
            ResultSet rs = ps.executeQuery();
            while (rs.next()) {
                model.addRow(new Object[]{rs.getInt("id"), rs.getString("title"), rs.getString("author"), rs.getInt("copies")});
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error: " + e.getMessage());
        }
    }

    private void loadBooks(DefaultTableModel model) {
        model.setRowCount(0);
        try (Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery("SELECT * FROM books")) {
            while (rs.next()) {
                model.addRow(new Object[]{rs.getInt("id"), rs.getString("title"), rs.getString("author"), rs.getInt("copies")});
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error loading books: " + e.getMessage());
        }
    }

    // ---------- View Members (Search + Delete) ----------
    private JPanel createViewMembersPanel() {
        JPanel panel = new JPanel(new BorderLayout(10, 10));
        panel.setBackground(Color.WHITE);

        String[] columns = {"ID", "Name", "Email"};
        DefaultTableModel model = new DefaultTableModel(columns, 0);
        JTable table = new JTable(model);
        JScrollPane scrollPane = new JScrollPane(table);

        JTextField searchField = new JTextField(15);
        JButton searchBtn = createButton("ðŸ” Search");
        JButton refreshBtn = createButton("ðŸ”„ Refresh");
        JButton deleteBtn = createButton("ðŸ—‘ï¸ Delete");

        JPanel topPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        topPanel.add(new JLabel("Search (Name/Email): "));
        topPanel.add(searchField);
        topPanel.add(searchBtn);
        topPanel.add(refreshBtn);
        topPanel.add(deleteBtn);

        panel.add(topPanel, BorderLayout.NORTH);
        panel.add(scrollPane, BorderLayout.CENTER);

        searchBtn.addActionListener(e -> searchMembers(model, searchField.getText()));
        refreshBtn.addActionListener(e -> loadMembers(model));
        deleteBtn.addActionListener(e -> deleteSelectedMember(table, model));

        loadMembers(model);
        return panel;
    }

    private void deleteSelectedMember(JTable table, DefaultTableModel model) {
        int row = table.getSelectedRow();
        if (row == -1) {
            JOptionPane.showMessageDialog(this, "Please select a member to delete.");
            return;
        }

        int id = (int) model.getValueAt(row, 0);
        int confirm = JOptionPane.showConfirmDialog(this, "Are you sure you want to delete this member?", "Confirm Delete", JOptionPane.YES_NO_OPTION);

        if (confirm == JOptionPane.YES_OPTION) {
            try {
                PreparedStatement ps = conn.prepareStatement("DELETE FROM members WHERE id = ?");
                ps.setInt(1, id);
                ps.executeUpdate();
                model.removeRow(row);
                JOptionPane.showMessageDialog(this, "ðŸ—‘ï¸ Member deleted successfully!");
            } catch (Exception e) {
                JOptionPane.showMessageDialog(this, "Error deleting member: " + e.getMessage());
            }
        }
    }

    private void searchMembers(DefaultTableModel model, String query) {
        model.setRowCount(0);
        try {
            PreparedStatement ps = conn.prepareStatement("SELECT * FROM members WHERE name LIKE ? OR email LIKE ?");
            ps.setString(1, "%" + query + "%");
            ps.setString(2, "%" + query + "%");
            ResultSet rs = ps.executeQuery();
            while (rs.next()) {
                model.addRow(new Object[]{rs.getInt("id"), rs.getString("name"), rs.getString("email")});
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error: " + e.getMessage());
        }
    }

    private void loadMembers(DefaultTableModel model) {
        model.setRowCount(0);
        try (Statement stmt = conn.createStatement();
             ResultSet rs = stmt.executeQuery("SELECT * FROM members")) {
            while (rs.next()) {
                model.addRow(new Object[]{rs.getInt("id"), rs.getString("name"), rs.getString("email")});
            }
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Error loading members: " + e.getMessage());
        }
    }

    // ---------- Helpers ----------
    private JPanel createStyledPanel(int rows) {
        JPanel panel = new JPanel(new GridLayout(rows, 2, 15, 15));
        panel.setBackground(Color.WHITE);
        panel.setBorder(new EmptyBorder(25, 25, 25, 25));
        return panel;
    }

    private JButton createButton(String text) {
        JButton btn = new JButton(text);
        btn.setFont(new Font("Segoe UI", Font.BOLD, 13));
        btn.setBackground(new Color(25, 118, 210));
        btn.setForeground(Color.WHITE);
        btn.setFocusPainted(false);
        btn.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
        return btn;
    }

    // ---------- MAIN ----------
    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> new LibraryGUI().setVisible(true));
    }
}
